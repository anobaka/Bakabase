name: Build and Deploy

on:
  push:
    branches: [ main, 'dev/v*' ]
  pull_request:
    branches: [ main, 'dev/v*' ]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Docker image tag (e.g., v1.2.3, 1.2.3, v1.2.3-alpha)'
        required: true
        type: string

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.set-var.outputs.version }}
      is_tag: ${{ steps.set-var.outputs.is_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get NBGV version info
        id: nbvg
        uses: dotnet/nbgv@master
        with:
          setAllVars: true

      - name: Set version and tag info
        id: set-var
        run: |
          echo "version=${{ env.NBGV_CloudBuildNumber }}" >> $GITHUB_OUTPUT
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            echo "is_tag=true" >> $GITHUB_OUTPUT
          else
            echo "is_tag=false" >> $GITHUB_OUTPUT
          fi

  build-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache Yarn
        uses: actions/cache@v4
        with:
          path: |
            src/web/.yarn/cache
            src/web/node_modules
          key: yarn-${{ runner.os }}-${{ hashFiles('src/web/yarn.lock') }}
          restore-keys: |
            yarn-${{ runner.os }}-

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Enable corepack
        run: corepack enable yarn

      - name: Install yarn dependencies
        working-directory: src/web
        run: yarn install

      - name: Build frontend
        working-directory: src/web
        run: yarn build

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: fe
          path: src/web/dist/*
        
  build:
    runs-on: ${{ matrix.os }}
    needs: [prepare, build-frontend]
    strategy:
      matrix:
        include:
          - os: windows-latest
            rid: win-x64
            artifact: win-x64
            csproj: Bakabase/src/Bakabase/Bakabase.csproj
            nuget-path: ~\\.nuget\\packages
          - os: ubuntu-latest
            rid: linux-x64
            artifact: docker
            csproj: Bakabase/src/Bakabase.Service/Bakabase.Service.csproj
            nuget-path: ~/.nuget/packages
    steps:
      - name: Checkout main repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for all branches and tags
          path: ${{ github.event.repository.name }}
      - name: Clone Bakabase.Infrastructures
        run: git clone https://github.com/anobaka/Bakabase.Infrastructures.git
      - name: Clone LazyMortal
        run: git clone https://github.com/anobaka/LazyMortal.git
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ${{ matrix.nuget-path }}
          key: nuget-${{ runner.os }}-${{ hashFiles('**/packages.lock.json', '**/*.csproj') }}
          restore-keys: |
            nuget-${{ runner.os }}-
      - name: Build Bakabase project
        run: dotnet publish ${{matrix.csproj}} --self-contained -r ${{ matrix.rid }} -o ./publish
      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: fe
          path: ./publish/web
      - name: Ensure config directory exists
        run: mkdir -p ./publish/AppData/configs
      - name: create-json
        uses: jsdaniell/create-json@v1.2.3
        with:
          name: "updater.json"
          json: ${{ secrets.UPDATER_JSON }}
          dir: ./publish/AppData/configs
      - name: Upload Bakabase build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ./publish/*

  deploy-oss:
    runs-on: ubuntu-latest
    needs: [ prepare, build ]
    strategy:
      matrix:
        include:
          - artifact: win-x64
    steps:
      - name: Download Bakabase build artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: .

      - name: Install ossutil
        run: |
          wget -O ossutil64 https://gosspublic.alicdn.com/ossutil/1.7.16/ossutil64
          chmod +x ossutil64

      - name: Upload all files to OSS
        env:
          OSS_ACCESS_KEY_ID: ${{ secrets.OSS_ACCESS_KEY_ID }}
          OSS_ACCESS_KEY_SECRET: ${{ secrets.OSS_ACCESS_KEY_SECRET }}
          OSS_ENDPOINT: http://oss-accelerate.aliyuncs.com
        run: |
          ./ossutil64 config -e $OSS_ENDPOINT -i $OSS_ACCESS_KEY_ID -k $OSS_ACCESS_KEY_SECRET
          ./ossutil64 cp -rf . oss://anobaka-public/app/bakabase/inside-world/${{ needs.prepare.outputs.version }}/unpacked/win/

      - name: Zip all files
        run: |
          zip -r bakabase.zip .

      - name: Upload zip to OSS
        run: |
          ./ossutil64 cp bakabase.zip oss://anobaka-public/app/bakabase/inside-world/${{ needs.prepare.outputs.version }}/installer/bakabase.zip

  deploy-docker:
    runs-on: ubuntu-latest
    needs: [ prepare, build, build-frontend ]
    steps:
      - name: Checkout main repo
        uses: actions/checkout@v4
        
      - name: Download Bakabase build artifact
        uses: actions/download-artifact@v4
        with:
          name: docker
          path: ./publish

      - name: Set Docker build context
        id: docker_context
        run: |
          echo "DOCKERFILE=docker/Dockerfile" >> $GITHUB_ENV
          echo "DOCKER_TAG=${{ needs.prepare.outputs.version }}" >> $GITHUB_ENV
      - name: Show working directory
        run: |
          echo "Working directory: $(pwd)"
          echo "------------------------------------------"
      - name: Build Docker image
        run: |
          echo "Building Docker image 'bakabase:${DOCKER_TAG}' using Dockerfile '${DOCKERFILE}'..."
          docker build --progress=plain -f "${DOCKERFILE}" -t bakabase:${DOCKER_TAG} ./publish
          echo "Docker image 'bakabase:${DOCKER_TAG}' built successfully"
      - name: Log in to Docker Hub
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
      - name: Tag and push Docker image
        run: |
          docker tag bakabase:${DOCKER_TAG} ${{ secrets.DOCKERHUB_USERNAME }}/bakabase:${DOCKER_TAG}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/bakabase:${DOCKER_TAG}

  deploy-release:
    runs-on: ubuntu-latest
    needs: [ prepare, build ]
    if: startsWith(github.ref, 'refs/tags/')
    strategy:
      matrix:
        include:
          - artifact: win-x64
    steps:
      - name: Download Bakabase build artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{matrix.artifact}}
          path: .

      - name: Zip all files
        run: |
          zip -r bakabase-${{needs.prepare.outputs.version}}-${{matrix.artifact}}.zip .

      - name: Create GitHub Release and Upload zip
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{needs.prepare.outputs.version}}
          name: ${{needs.prepare.outputs.version}}
          files: bakabase-${{needs.prepare.outputs.version}}-${{matrix.artifact}}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}